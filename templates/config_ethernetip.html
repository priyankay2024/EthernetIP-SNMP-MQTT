{% extends "base.html" %}
{% block title %}EthernetIP Configuration{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, .5)
    }

    .modal-content {
        background: #fff;
        margin: 5% auto;
        padding: 0;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, .15)
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center
    }

    .modal-header h2 {
        margin: 0;
        color: #333;
        font-size: 1.5rem
    }

    .modal-body {
        padding: 25px
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px
    }

    .close {
        color: #666;
        font-size: 32px;
        font-weight: 700;
        cursor: pointer;
        background: 0 0;
        border: none;
        padding: 0;
        line-height: 1
    }

    .close:hover {
        color: #000
    }

    .form-group {
        margin-bottom: 20px
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color .3s
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: 0;
        border-color: var(--primary-color)
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all .3s
    }

    .btn-primary {
        background: var(--primary-color);
        color: #fff
    }

    .btn-primary:hover {
        background: #d63e0a
    }

    .btn-secondary {
        background: #6c757d;
        color: #fff
    }

    .btn-secondary:hover {
        background: #5a6268
    }

    .actions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px
    }

    .actions-header h1 {
        margin: 0;
        color: #333
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500
    }

    .status-connected {
        background: #d4edda;
        color: #155724
    }

    .status-disconnected {
        background: #f8d7da;
        color: #721c24
    }

    .table-wrapper {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
        overflow: hidden
    }

    table {
        width: 100%;
        border-collapse: collapse
    }

    thead {
        background: #f8f9fa
    }

    th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6
    }

    td {
        padding: 15px;
        border-bottom: 1px solid #dee2e6
    }

    tbody tr:hover {
        background: #f8f9fa
    }

    .action-btn {
        padding: 6px 12px;
        margin: 0 4px;
        background: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px
    }

    .action-btn:hover {
        background: #d63e0a
    }

    .action-btn.secondary {
        background: #6c757d
    }

    .action-btn.secondary:hover {
        background: #5a6268
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 25px;
        gap: 10px
    }

    .pagination a,
    .pagination span {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        color: #495057;
        text-decoration: none
    }

    .pagination a:hover {
        background: #f8f9fa
    }

    .pagination .active {
        background: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color)
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: .5
    }

    .tags-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        margin-top: 10px;
        background: #f9f9f9
    }

    .tag-item {
        display: grid;
        grid-template-columns: 30px 1fr;
        gap: 8px;
        padding: 10px 12px;
        border-bottom: 1px solid #e0e0e0;
        background: #fff;
        margin-bottom: 4px;
        border-radius: 4px;
        transition: background 0.2s;
        align-items: start
    }

    .tag-item:hover {
        background: #f5f5f5
    }

    .tag-item:last-child {
        margin-bottom: 0
    }

    .tag-item input[type="checkbox"] {
        margin: 0;
        margin-top: 2px;
        width: 18px;
        height: 18px;
        cursor: pointer
    }

    .tag-item label {
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 100%
    }

    .tag-item label strong {
        color: #333;
        font-size: 14px;
        word-break: break-word
    }

    .tag-item label span {
        font-size: 12px;
        color: #888
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg)
        }

        100% {
            transform: rotate(360deg)
        }
    }

    .rotating {
        animation: spin 1s linear infinite
    }

    .discover-section {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px dashed #dee2e6;
    }

    .discover-section p {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 14px;
    }

    .selected-count {
        background: var(--primary-color);
        color: #fff;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        margin-left: 10px;
    }
</style>
<div class="actions-header">
    <h1>EthernetIP Configuration</h1><button class="btn btn-primary" onclick="showAddModal()">Add New Device</button>
</div>

<!-- Search Filter -->
<div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
    <input type="text" id="searchInput" placeholder="Search by device name or IP address..." 
           style="width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
           oninput="filterTable()">
</div>

<script>
function filterTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    });
}
</script>

<div class="table-wrapper">{% if configs %}<table>
        <thead>
            <tr>
                <th>Sr.No</th>
                <th>Device Name</th>
                <th>IP Address</th>
                <th>HWID</th>
                <th>Polling Interval</th>
                <th>Slot</th>
                <th>Timeout</th>
                <th>Connection Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>{% for config in configs %}<tr>
                <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                <td>{{ config.name }}</td>
                <td>{{ config.ip_address }}</td>
                <td>{{ config.hwid or '-' }}</td>
                <td>{{ config.polling_interval }}ms</td>
                <td>{{ config.slot }}</td>
                <td>{{ config.timeout }}s</td>
                <td><span class="status-badge status-disconnected" id="status-{{ config.id }}">Checking...</span></td>
                <td>
                    <button class="action-btn"
                        onclick="showEditModal({{ config.id }}, '{{ config.name }}', '{{ config.hwid or '' }}', '{{ config.description or '' }}', '{{ config.ip_address }}', {{ config.slot }}, {{ config.timeout }}, {{ config.polling_interval }})">Edit</button>
                    <form method="POST" style="display:inline"><input type="hidden" name="action" value="delete"><input
                            type="hidden" name="config_id" value="{{ config.id }}"><button type="submit"
                            class="action-btn secondary" onclick="return confirm('Delete this device?')">Delete</button>
                    </form>
                </td>
            </tr>{% endfor %}</tbody>
    </table>{% else %}<div class="empty-state"><i class="material-icons">devices</i>
        <h3>No EthernetIP devices configured</h3>
        <p>Click "Add New Device" to get started</p>
    </div>{% endif %}</div>
{% if pagination %}
<div class="pagination">
    {% if pagination.has_prev %}
    <a href="{{ url_for('main.config_ethernetip', page=pagination.prev_num) }}">Previous</a>
    {% endif %}
    <span class="active">Page {{ pagination.page }}</span>
    <span>of {{ pagination.pages }} ({{ pagination.total }} devices)</span>
    {% if pagination.has_next %}
    <a href="{{ url_for('main.config_ethernetip', page=pagination.next_num) }}">Next</a>
    {% endif %}
</div>
{% endif %}
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add EthernetIP Device</h2><button class="close" onclick="closeAddModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addForm" method="POST"><input type="hidden" name="action" value="add">
                <div class="form-group"><label>Device Name</label><input type="text" name="name" required
                        placeholder="PLC1"></div>
                <div class="form-group"><label>HWID</label><input type="text" name="hwid" placeholder="HWID"></div>
                <div class="form-group"><label>Description</label><input type="text" name="description"
                        placeholder="Device description (optional)"></div>
                <div class="form-group"><label>IP Address</label><input type="text" name="ip_address"
                        id="new_ip_address" required placeholder="192.168.1.100"></div>
                <div class="form-group"><label>Slot</label><input type="number" name="slot" id="new_slot" value="0"
                        required></div>
                <div class="form-group"><label>Timeout (seconds)</label><input type="number" name="timeout"
                        id="new_timeout" value="5.0" step="0.1" required></div>
                <div class="form-group"><label>Polling Interval (ms)</label><input type="number" name="polling_interval"
                        value="1000" min="100" step="100" required></div>
                <!-- <div class="form-group"><button type="button" class="btn btn-secondary" style="width:100%"
                        onclick="discoverNewDeviceTags()"><i class="material-icons"
                            style="vertical-align:middle;font-size:18px">search</i> Discover Tags</button>
                    <span id="tagSelectedCount" class="selected-count" style="display:none;">0 selected</span>
                </div> -->
                <div class="discover-section">
                    <p>Discover and select Tags to monitor</p>
                    <button type="button" class="btn btn-secondary" id="discoverBtn" onclick="discoverNewDeviceTags()">
                        Discover Tags
                    </button>
                    <span id="tagSelectedCount" class="selected-count" style="display:none;">0 selected</span>
                </div>
                <div id="discoveredTags" style="display:none">
                    <div class="form-group">
                        <label>Discovered Tags (<span id="tagCount">0</span>)</label>
                        <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="tagSearchFilter" placeholder="Search tags by name or data type..."
                                style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;"
                                oninput="filterTagList()">
                            <button type="button" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;"
                                onclick="toggleSelectAllTags()">
                                <span id="selectAllTagsText">Deselect All</span>
                            </button>
                        </div>
                        <div id="tagsList" class="tags-list"></div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button><button
                class="btn btn-primary" onclick="submitAddForm()">Add Device</button></div>
    </div>
</div>
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit EthernetIP Device</h2><button class="close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editForm" method="POST"><input type="hidden" name="action" value="update"><input type="hidden"
                    name="config_id" id="edit_config_id">
                <div class="form-group"><label>Device Name</label><input type="text" name="name" id="edit_name"
                        required></div>
                <div class="form-group"><label>HWID</label><input type="text" name="hwid" id="edit_hwid"
                        placeholder="HWID"></div>
                <div class="form-group"><label>Description</label><input type="text" name="description"
                        id="edit_description" placeholder="Device description (optional)"></div>
                <div class="form-group"><label>IP Address</label><input type="text" name="ip_address"
                        id="edit_ip_address" required></div>
                <div class="form-group"><label>Slot</label><input type="number" name="slot" id="edit_slot" required>
                </div>
                <div class="form-group"><label>Timeout (seconds)</label><input type="number" name="timeout"
                        id="edit_timeout" step="0.1" required></div>
                <div class="form-group"><label>Polling Interval (ms)</label><input type="number" name="polling_interval"
                        id="edit_polling_interval" min="100" step="100" required></div>
                
                <!-- Tag Management Section -->
                <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #f0f0f0;">
                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">Configure Tags</h3>
                    
                    <div class="discover-section">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                            <input type="text" id="editTagSearchFilter" placeholder="Search tags..." 
                                   style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
                                   oninput="filterEditTagList()">
                            <button type="button" class="btn btn-secondary" style="padding: 8px 16px; white-space: nowrap;"
                                    id="toggleEditSelectAllTags" onclick="toggleEditSelectAllTags()">
                                <span id="editSelectAllTagsText">Select All</span>
                            </button>
                            <span class="selected-count" id="editTagSelectedCount" style="display: none;">0 selected</span>
                        </div>
                        
                        <div id="editTagsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; background: #fff;">
                            <p style="text-align:center;color:#666;padding:20px;">Loading tags...</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button><button
                class="btn btn-primary" onclick="submitEditForm()">Update Device</button></div>
    </div>
</div>
<div id="tagsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="tagsModalTitle">Tags</h2><button class="close" onclick="closeTagsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="tagsContent">
                <p style="text-align:center;color:#666">Loading tags...</p>
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeTagsModal()">Close</button></div>
    </div>
</div>
<script>function showAddModal() { document.getElementById('addModal').style.display = 'block' } function closeAddModal() { document.getElementById('addModal').style.display = 'none'; document.getElementById('discoveredTags').style.display = 'none'; document.getElementById('tagsList').innerHTML = '' } function showEditModal(id, name, hwid, description, ip, slot, timeout, polling_interval) { document.getElementById('editModal').style.display = 'block'; document.getElementById('edit_config_id').value = id; document.getElementById('edit_name').value = name; document.getElementById('edit_hwid').value = hwid; document.getElementById('edit_description').value = description; document.getElementById('edit_ip_address').value = ip; document.getElementById('edit_slot').value = slot; document.getElementById('edit_timeout').value = timeout; document.getElementById('edit_polling_interval').value = polling_interval; loadDeviceTags(id); } function closeEditModal() { document.getElementById('editModal').style.display = 'none' } function submitEditForm() { const form = document.getElementById('editForm'); const checkboxes = document.querySelectorAll('#editTagsList .tag-checkbox:checked'); const selectedTags = Array.from(checkboxes).map(cb => cb.value); let input = form.querySelector('input[name="selected_tags"]'); if (!input) { input = document.createElement('input'); input.type = 'hidden'; input.name = 'selected_tags'; form.appendChild(input); } input.value = JSON.stringify(selectedTags); console.log('Edit - selected tags:', selectedTags.length); form.submit() } function closeTagsModal() { document.getElementById('tagsModal').style.display = 'none' } function submitAddForm() { const form = document.getElementById('addForm'); const checkboxes = document.querySelectorAll('#tagsList .tag-checkbox:checked'); const selectedTags = Array.from(checkboxes).map(cb => cb.value); console.log('Selected tags array:', selectedTags); console.log('Number of checked boxes:', checkboxes.length); if (selectedTags.length > 0) { let input = form.querySelector('input[name="selected_tags"]'); if (!input) { input = document.createElement('input'); input.type = 'hidden'; input.name = 'selected_tags'; form.appendChild(input); } input.value = JSON.stringify(selectedTags); console.log('JSON value being submitted:', input.value); } else { console.warn('No tags selected - device will be added without tags'); } form.submit() } async function discoverNewDeviceTags() { const ip = document.getElementById('new_ip_address').value, slot = document.getElementById('new_slot').value, timeout = document.getElementById('new_timeout').value; if (!ip) { alert('Please enter IP address first'); return } const btn = event.target; btn.disabled = true; btn.innerHTML = '<i class="material-icons rotating" style="vertical-align:middle;font-size:18px">sync</i> Discovering...'; try { const r = await fetch('/api/ethernetip/discover-tags', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip_address: ip, slot: parseInt(slot), timeout: parseFloat(timeout) }) }); const d = await r.json(); if (d.success) { displayTags(d.tags); document.getElementById('discoveredTags').style.display = 'block' } else { alert('Failed: ' + d.message) } } catch (e) { alert('Error: ' + e.message) } finally { btn.disabled = false; btn.innerHTML = '<i class="material-icons" style="vertical-align:middle;font-size:18px">search</i> Discover Tags' } } function displayTags(tags) { const list = document.getElementById('tagsList'); list.innerHTML = ''; document.getElementById('tagCount').textContent = tags.length; if (!tags.length) { list.innerHTML = '<p style="padding:12px;color:#666;text-align:center">No tags found</p>'; return } tags.forEach((tag, i) => { const item = document.createElement('div'); item.className = 'tag-item'; item.setAttribute('data-tag-name', tag.name.toLowerCase()); item.setAttribute('data-tag-type', tag.data_type.toLowerCase()); item.innerHTML = '<input type="checkbox" class="tag-checkbox" id="tag_' + i + '" value="' + tag.name + '" checked onchange="updateTagCount()"><label for="tag_' + i + '"><strong>' + tag.name + '</strong><span>Data Type: ' + tag.data_type + '</span></label>'; list.appendChild(item) }); updateTagCount(); console.log('Displayed ' + tags.length + ' tags with checkboxes') } function updateTagCount() { const checked = document.querySelectorAll('#tagsList .tag-checkbox:checked').length; const total = document.querySelectorAll('#tagsList .tag-checkbox').length; const countElem = document.getElementById('tagSelectedCount'); if (countElem) { countElem.textContent = checked + ' selected'; countElem.style.display = total > 0 ? 'inline-block' : 'none'; } } function filterTagList() { const searchValue = document.getElementById('tagSearchFilter').value.toLowerCase(); const items = document.querySelectorAll('#tagsList .tag-item'); let visibleCount = 0; items.forEach(item => { const tagName = item.getAttribute('data-tag-name') || ''; const tagType = item.getAttribute('data-tag-type') || ''; if (tagName.includes(searchValue) || tagType.includes(searchValue)) { item.style.display = ''; visibleCount++; } else { item.style.display = 'none'; } }); } function toggleSelectAllTags() { const checkboxes = Array.from(document.querySelectorAll('#tagsList .tag-item')).filter(item => item.style.display !== 'none').map(item => item.querySelector('.tag-checkbox')); const allChecked = checkboxes.every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !allChecked); document.getElementById('selectAllTagsText').textContent = allChecked ? 'Select All' : 'Deselect All'; updateTagCount(); } 
async function loadDeviceTags(configId) { const list = document.getElementById('editTagsList'); list.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">Loading tags...</p>'; try { const r = await fetch('/api/ethernetip/discover-tags', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config_id: configId }) }); const d = await r.json(); if (d.success) { displayEditTags(d.tags, d.existing_tags || []); } else { list.innerHTML = '<p style="text-align:center;color:#d32f2f;padding:20px;">Failed to load tags: ' + d.message + '</p>'; } } catch (e) { list.innerHTML = '<p style="text-align:center;color:#d32f2f;padding:20px;">Error: ' + e.message + '</p>'; } } 
function displayEditTags(allTags, existingTags) { const list = document.getElementById('editTagsList'); list.innerHTML = ''; if (!allTags.length) { list.innerHTML = '<p style="padding:12px;color:#666;text-align:center">No tags found</p>'; return } const existingTagNames = new Set(existingTags.filter(t => t.enabled).map(t => t.tag_name)); allTags.forEach((tag, i) => { const item = document.createElement('div'); item.className = 'tag-item'; item.setAttribute('data-tag-name', tag.name.toLowerCase()); item.setAttribute('data-tag-type', tag.data_type.toLowerCase()); const isChecked = existingTagNames.has(tag.name); item.innerHTML = '<input type="checkbox" class="tag-checkbox" id="edit_tag_' + i + '" value="' + tag.name + '" ' + (isChecked ? 'checked' : '') + ' onchange="updateEditTagCount()"><label for="edit_tag_' + i + '"><strong>' + tag.name + '</strong><span>Data Type: ' + tag.data_type + '</span></label>'; list.appendChild(item) }); updateEditTagCount(); } 
function updateEditTagCount() { const checked = document.querySelectorAll('#editTagsList .tag-checkbox:checked').length; const total = document.querySelectorAll('#editTagsList .tag-checkbox').length; const countElem = document.getElementById('editTagSelectedCount'); if (countElem) { countElem.textContent = checked + ' selected'; countElem.style.display = total > 0 ? 'inline-block' : 'none'; } } 
function filterEditTagList() { const searchValue = document.getElementById('editTagSearchFilter').value.toLowerCase(); const items = document.querySelectorAll('#editTagsList .tag-item'); items.forEach(item => { const tagName = item.getAttribute('data-tag-name') || ''; const tagType = item.getAttribute('data-tag-type') || ''; if (tagName.includes(searchValue) || tagType.includes(searchValue)) { item.style.display = ''; } else { item.style.display = 'none'; } }); } 
function toggleEditSelectAllTags() { const checkboxes = Array.from(document.querySelectorAll('#editTagsList .tag-item')).filter(item => item.style.display !== 'none').map(item => item.querySelector('.tag-checkbox')); const allChecked = checkboxes.every(cb => cb.checked); checkboxes.forEach(cb => cb.checked = !allChecked); document.getElementById('editSelectAllTagsText').textContent = allChecked ? 'Select All' : 'Deselect All'; updateEditTagCount(); } 
async function showDeviceTags(configId) { const modal = document.getElementById('tagsModal'), content = document.getElementById('tagsContent'), title = document.getElementById('tagsModalTitle'); title.textContent = 'Configured Tags'; modal.style.display = 'block'; content.innerHTML = '<p style="text-align:center;color:#666"><i class="material-icons rotating" style="font-size:48px;display:block;margin:20px auto">sync</i>Loading tags...</p>'; try { const r = await fetch('/api/ethernetip/device-tags/' + configId); const d = await r.json(); if (d.success && d.tags.length > 0) { let html = '<h3 style="margin:0 0 15px 0;color:#333">Configured Tags (' + d.tags.length + ')</h3><table style="width:100%"><thead><tr><th>Tag Name</th><th>Data Type</th><th>Enabled</th></tr></thead><tbody>'; d.tags.forEach(tag => { html += '<tr><td><strong>' + tag.tag_name + '</strong></td><td>' + tag.data_type + '</td><td>' + (tag.enabled ? '<span style="color:#28a745">✓ Yes</span>' : '<span style="color:#dc3545">✗ No</span>') + '</td></tr>' }); html += '</tbody></table>'; content.innerHTML = html } else { content.innerHTML = '<div class="empty-state"><i class="material-icons">info</i><h3>No Tags Configured</h3><p>Click "Discover New" to find and add tags</p></div>' } } catch (e) { content.innerHTML = '<div style="color:#d32f2f;text-align:center;padding:20px"><i class="material-icons" style="font-size:48px;display:block;margin-bottom:10px">error</i><p>Error: ' + e.message + '</p></div>' } } async function discoverTags(configId) { const modal = document.getElementById('tagsModal'), content = document.getElementById('tagsContent'), title = document.getElementById('tagsModalTitle'); title.textContent = 'Discover New Tags'; modal.style.display = 'block'; content.innerHTML = '<p style="text-align:center;color:#666"><i class="material-icons rotating" style="font-size:48px;display:block;margin:20px auto">sync</i>Discovering new tags...</p>'; try { const r = await fetch('/api/ethernetip/discover-tags', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config_id: configId }) }); const d = await r.json(); if (d.success && d.tags.length > 0) { let html = '<h3 style="margin:0 0 15px 0;color:#333">Discovered Tags (' + d.tags.length + ')</h3><table style="width:100%"><thead><tr><th>Tag Name</th><th>Data Type</th></tr></thead><tbody>'; d.tags.forEach(tag => { html += '<tr><td><strong>' + tag.name + '</strong></td><td>' + tag.data_type + '</td></tr>' }); html += '</tbody></table>'; content.innerHTML = html } else { content.innerHTML = '<div class="empty-state"><i class="material-icons">search_off</i><h3>No Tags Found</h3><p>No tags discovered from this device</p></div>' } } catch (e) { content.innerHTML = '<div style="color:#d32f2f;text-align:center;padding:20px"><i class="material-icons" style="font-size:48px;display:block;margin-bottom:10px">error</i><p>Error: ' + e.message + '</p></div>' } } async function updateConnectionStatus() { document.querySelectorAll('[id^="status-"]').forEach(async e => { const id = e.id.replace('status-', ''); try { const r = await fetch('/api/ethernetip/connection-status/' + id); const d = await r.json(); if (d.success) { e.textContent = d.connected ? 'Connected' : 'Disconnected'; e.className = 'status-badge ' + (d.connected ? 'status-connected' : 'status-disconnected') } else { e.textContent = 'Unknown' } } catch (err) { e.textContent = 'Error'; e.className = 'status-badge status-disconnected' } }) } window.onclick = function (e) { const addModal = document.getElementById('addModal'), editModal = document.getElementById('editModal'), tagsModal = document.getElementById('tagsModal'); if (e.target == addModal) closeAddModal(); if (e.target == editModal) closeEditModal(); if (e.target == tagsModal) closeTagsModal() }; updateConnectionStatus(); setInterval(updateConnectionStatus, 10000)</script>

{% endblock %}