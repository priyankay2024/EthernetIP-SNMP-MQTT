{% extends "base.html" %}
{% block title %}MQTT Configuration{% endblock %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, .5)
    }

    .modal-content {
        background: #fff;
        margin: 5% auto;
        padding: 0;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, .15)
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center
    }

    .modal-header h2 {
        margin: 0;
        color: #333;
        font-size: 1.5rem
    }

    .modal-body {
        padding: 25px
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px
    }

    .close {
        color: #666;
        font-size: 32px;
        font-weight: 700;
        cursor: pointer;
        background: 0 0;
        border: none;
        padding: 0;
        line-height: 1
    }

    .close:hover {
        color: #000
    }

    .form-group {
        margin-bottom: 20px
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color .3s
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: 0;
        border-color: var(--primary-color)
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px
    }

    .form-check input[type="checkbox"] {
        width: auto
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all .3s
    }

    .btn-primary {
        background: var(--primary-color);
        color: #fff
    }

    .btn-primary:hover {
        background: #d63e0a
    }

    .btn-secondary {
        background: #6c757d;
        color: #fff
    }

    .btn-secondary:hover {
        background: #5a6268
    }

    .actions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px
    }

    .actions-header h1 {
        margin: 0;
        color: #333
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500
    }

    .status-connected {
        background: #d4edda;
        color: #155724
    }

    .status-disconnected {
        background: #f8d7da;
        color: #721c24
    }

    .table-wrapper {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
        overflow: hidden
    }

    table {
        width: 100%;
        border-collapse: collapse
    }

    thead {
        background: #f8f9fa
    }

    th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6
    }

    td {
        padding: 15px;
        border-bottom: 1px solid #dee2e6
    }

    tbody tr:hover {
        background: #f8f9fa
    }

    .action-btn {
        padding: 6px 12px;
        margin: 0 4px;
        background: var(--primary-color);
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px
    }

    .action-btn:hover {
        background: #d63e0a
    }

    .action-btn.secondary {
        background: #6c757d
    }

    .action-btn.secondary:hover {
        background: #5a6268
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 25px;
        gap: 10px
    }

    .pagination a,
    .pagination span {
        padding: 8px 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        color: #495057;
        text-decoration: none
    }

    .pagination a:hover {
        background: #f8f9fa
    }

    .pagination .active {
        background: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color)
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: .5
    }
</style>
<div class="actions-header">
    <h1>MQTT Configuration</h1><button class="btn btn-primary" onclick="showAddModal()">Add New Broker</button>
</div>

<!-- Search Filter -->
<div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
    <input type="text" id="searchInput" placeholder="Search by broker name, host, or port..." 
           style="width: 100%; padding: 12px 16px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
           oninput="filterTable()">
</div>

<script>
function filterTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    });
}
</script>

<div class="table-wrapper">{% if configs %}<table>
        <thead>
            <tr>
                <th>Sr.No</th>
                <th>Broker Name</th>
                <th>Broker Address</th>
                <th>Port</th>
                <th>Format</th>
                <th>TLS</th>
                <th>Connection Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>{% for config in configs %}<tr>
                <td>{{ (pagination.page - 1) * pagination.per_page + loop.index }}</td>
                <td>{{ config.name }}</td>
                <td>{{ config.broker }}</td>
                <td>{{ config.port }}</td>
                <td>{{ config.publish_format or 'json' }}</td>
                <td>{% if config.use_tls %}<span style="color:#28a745">✓ Enabled</span>{% else %}<span
                        style="color:#6c757d">✗ Disabled</span>{% endif %}</td>
                <td><span class="status-badge status-disconnected" id="status-{{ config.id }}">Checking...</span></td>
                <td>
                    <button class="action-btn" onclick="showEditModal({{ config.id }})">Edit</button>
                    <form method="POST" style="display:inline"><input type="hidden" name="action" value="delete"><input
                            type="hidden" name="config_id" value="{{ config.id }}"><button type="submit"
                            class="action-btn secondary" onclick="return confirm('Delete this broker?')">Delete</button>
                    </form>
                </td>
            </tr>{% endfor %}</tbody>
    </table>{% else %}<div class="empty-state"><i class="material-icons">cloud_off</i>
        <h3>No MQTT brokers configured</h3>
        <p>Click "Add New Broker" to get started</p>
    </div>{% endif %}</div>
{% if pagination %}
<div class="pagination">
    {% if pagination.has_prev %}
    <a href="{{ url_for('main.config_mqtt', page=pagination.prev_num) }}">Previous</a>
    {% endif %}
    <span class="active">Page {{ pagination.page }}</span>
    <span>of {{ pagination.pages }} ({{ pagination.total }} brokers)</span>
    {% if pagination.has_next %}
    <a href="{{ url_for('main.config_mqtt', page=pagination.next_num) }}">Next</a>
    {% endif %}
</div>
{% endif %}
<div id="addModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add MQTT Broker</h2><button class="close" onclick="closeAddModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addForm" method="POST"><input type="hidden" name="action" value="add">
                <div class="form-group"><label>Broker Name</label><input type="text" name="name" required
                        placeholder="My MQTT Broker"></div>
                <div class="form-group"><label>Broker Address</label><input type="text" name="broker" required
                        placeholder="mqtt.example.com"></div>
                <div class="form-group"><label>Port</label><input type="number" name="port" value="1883" required></div>
                <div class="form-group"><label>Username (optional)</label><input type="text" name="username"
                        placeholder="username"></div>
                <div class="form-group"><label>Password (optional)</label><input type="password" name="password"
                        placeholder="password"></div>
                <div class="form-group">
                    <label>Publish Format</label>
                    <select name="publish_format" required>
                        <option value="json">JSON</option>
                        <option value="string">String (CSV)</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check"><input type="checkbox" name="use_tls" id="use_tls"><label
                            for="use_tls">Enable TLS/SSL</label></div>
                </div>
                
                <!-- Data Publishing Section -->
                <h3 style="margin: 25px 0 15px 0; color: #333; border-top: 1px solid #ddd; padding-top: 20px;">Data Publishing</h3>
                <div class="form-group"><label>Publish Topic</label><input type="text" name="publish_topic"
                        placeholder="sensors/data" required></div>
                <div class="form-group"><label>Subscribe Topic (optional)</label><input type="text" name="subscribe_topic"
                        placeholder="commands/device"></div>
                <div class="form-group"><label>Publish Interval (seconds)</label><input type="number" name="publish_interval" value="5" min="1"
                        required></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button><button
                class="btn btn-primary" onclick="submitAddForm()">Add Broker</button></div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit MQTT Broker</h2><button class="close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editForm" method="POST"><input type="hidden" name="action" value="update">
                <input type="hidden" name="config_id" id="editConfigId">
                <div class="form-group"><label>Broker Name</label><input type="text" name="name" id="editName" required
                        placeholder="My MQTT Broker"></div>
                <div class="form-group"><label>Broker Address</label><input type="text" name="broker" id="editBroker" required
                        placeholder="mqtt.example.com"></div>
                <div class="form-group"><label>Port</label><input type="number" name="port" id="editPort" value="1883" required></div>
                <div class="form-group"><label>Username (optional)</label><input type="text" name="username" id="editUsername"
                        placeholder="username"></div>
                <div class="form-group"><label>Password (optional)</label><input type="password" name="password" id="editPassword"
                        placeholder="Leave empty to keep current"></div>
                <div class="form-group">
                    <label>Publish Format</label>
                    <select name="publish_format" id="editPublishFormat" required>
                        <option value="json">JSON</option>
                        <option value="string">String (CSV)</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="form-check"><input type="checkbox" name="use_tls" id="editUseTls"><label
                            for="editUseTls">Enable TLS/SSL</label></div>
                </div>
                
                <!-- Data Publishing Section -->
                <h3 style="margin: 25px 0 15px 0; color: #333; border-top: 1px solid #ddd; padding-top: 20px;">Data Publishing</h3>
                <div class="form-group"><label>Publish Topic</label><input type="text" name="publish_topic" id="editPublishTopic"
                        placeholder="sensors/data" required></div>
                <div class="form-group"><label>Subscribe Topic (optional)</label><input type="text" name="subscribe_topic" id="editSubscribeTopic"
                        placeholder="commands/device"></div>
                <div class="form-group"><label>Publish Interval (seconds)</label><input type="number" name="publish_interval" id="editPublishInterval" value="5" min="1"
                        required></div>
                <div class="form-group">
                    <div class="form-check"><input type="checkbox" name="enabled" id="editEnabled"><label
                            for="editEnabled">Enable Configuration</label></div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button><button
                class="btn btn-primary" onclick="submitEditForm()">Update Broker</button></div>
    </div>
</div>

<script>
function showAddModal() { document.getElementById('addModal').style.display = 'block' } 
function closeAddModal() { document.getElementById('addModal').style.display = 'none' } 
function submitAddForm() { document.getElementById('addForm').submit() } 

async function showEditModal(configId) {
    try {
        const response = await fetch(`/api/mqtt/config/${configId}`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('editConfigId').value = data.id;
            document.getElementById('editName').value = data.name;
            document.getElementById('editBroker').value = data.broker;
            document.getElementById('editPort').value = data.port;
            document.getElementById('editUsername').value = data.username;
            document.getElementById('editPublishFormat').value = data.publish_format;
            document.getElementById('editUseTls').checked = data.use_tls;
            document.getElementById('editPublishTopic').value = data.publish_topic;
            document.getElementById('editSubscribeTopic').value = data.subscribe_topic;
            document.getElementById('editPublishInterval').value = data.publish_interval;
            document.getElementById('editEnabled').checked = data.enabled;
            document.getElementById('editModal').style.display = 'block';
        } else {
            alert('Error loading config: ' + data.message);
        }
    } catch (error) {
        console.error('Error fetching config:', error);
        alert('Error loading config data');
    }
}

function closeEditModal() { 
    document.getElementById('editModal').style.display = 'none' 
} 

function submitEditForm() { 
    document.getElementById('editForm').submit() 
} 

async function updateConnectionStatus() { document.querySelectorAll('[id^="status-"]').forEach(async e => { const t = e.id.replace('status-', ''); try { const o = await fetch('/api/mqtt/connection-status/' + t), n = await o.json(); n.success ? (e.textContent = n.connected ? 'Connected' : 'Disconnected', e.className = 'status-badge ' + (n.connected ? 'status-connected' : 'status-disconnected')) : e.textContent = 'Unknown' } catch (t) { e.textContent = 'Error', e.className = 'status-badge status-disconnected' } }) } 

window.onclick = function (e) { 
    const addModal = document.getElementById('addModal');
    const editModal = document.getElementById('editModal'); 
    if (e.target == addModal) {
        closeAddModal();
    } else if (e.target == editModal) {
        closeEditModal();
    }
};

updateConnectionStatus();
setInterval(updateConnectionStatus, 1e4);
</script>
{% endblock %}